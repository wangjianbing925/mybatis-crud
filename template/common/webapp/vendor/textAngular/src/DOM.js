angular.module("textAngular.DOM",["textAngular.factories"]).factory("taExecCommand",["taSelection","taBrowserTag","$document",function(e,t,n){var r=function(t,n){var r,a,o=t.find("li");for(a=o.length-1;a>=0;a--)r=angular.element("<"+n+">"+o[a].innerHTML+"</"+n+">"),t.after(r);t.remove(),e.setSelectionToElementEnd(r[0])},a=function(t){/(<br(|\/)>)$/i.test(t.innerHTML.trim())?e.setSelectionBeforeElement(angular.element(t).find("br")[0]):e.setSelectionToElementEnd(t)},o=function(e,t){var n=angular.element("<"+t+">"+e[0].innerHTML+"</"+t+">");e.after(n),e.remove(),a(n.find("li")[0])},l=function(e,n,r){for(var o="",l=0;l<e.length;l++)o+="<"+t("li")+">"+e[l].innerHTML+"</"+t("li")+">";var i=angular.element("<"+r+">"+o+"</"+r+">");n.after(i),n.remove(),a(i.find("li")[0])};return function(a,i){return a=t(a),function(s,d,c,g){var f,m,u,N,h,p,C,L=angular.element("<"+a+">");try{C=e.getSelectionElement()}catch(E){}var v=angular.element(C);if(void 0!==C){var S=C.tagName.toLowerCase();if("insertorderedlist"===s.toLowerCase()||"insertunorderedlist"===s.toLowerCase()){var T=t("insertorderedlist"===s.toLowerCase()?"ol":"ul");if(S===T)return r(v,a);if("li"===S&&v.parent()[0].tagName.toLowerCase()===T&&1===v.parent().children().length)return r(v.parent(),a);if("li"===S&&v.parent()[0].tagName.toLowerCase()!==T&&1===v.parent().children().length)return o(v.parent(),T);if(S.match(BLOCKELEMENTS)&&!v.hasClass("ta-bind")){if("ol"===S||"ul"===S)return o(v,T);var M=!1;return angular.forEach(v.children(),function(e){e.tagName.match(BLOCKELEMENTS)&&(M=!0)}),M?l(v.children(),v,T):l([angular.element("<div>"+C.innerHTML+"</div>")[0]],v,T)}if(S.match(BLOCKELEMENTS)){if(N=e.getOnlySelectedElements(),0===N.length)m=angular.element("<"+T+"><li>"+C.innerHTML+"</li></"+T+">"),v.html(""),v.append(m);else{if(1===N.length&&("ol"===N[0].tagName.toLowerCase()||"ul"===N[0].tagName.toLowerCase()))return N[0].tagName.toLowerCase()===T?r(angular.element(N[0]),a):o(angular.element(N[0]),T);u="";var w=[];for(f=0;f<N.length;f++)if(3!==N[f].nodeType){var H=angular.element(N[f]);if("li"===N[f].tagName.toLowerCase())continue;u+="ol"===N[f].tagName.toLowerCase()||"ul"===N[f].tagName.toLowerCase()?H[0].innerHTML:"span"!==N[f].tagName.toLowerCase()||"ol"!==N[f].childNodes[0].tagName.toLowerCase()&&"ul"!==N[f].childNodes[0].tagName.toLowerCase()?"<"+t("li")+">"+H[0].innerHTML+"</"+t("li")+">":H[0].childNodes[0].innerHTML,w.unshift(H)}m=angular.element("<"+T+">"+u+"</"+T+">"),w.pop().replaceWith(m),angular.forEach(w,function(e){e.remove()})}return void e.setSelectionToElementEnd(m[0])}}else{if("formatblock"===s.toLowerCase()){for(p=c.toLowerCase().replace(/[<>]/gi,""),"default"===p.trim()&&(p=a,c="<"+a+">"),m="li"===S?v.parent():v;!m[0].tagName||!m[0].tagName.match(BLOCKELEMENTS)&&!m.parent().attr("contenteditable");)m=m.parent(),S=(m[0].tagName||"").toLowerCase();if(S===p){N=m.children();var b=!1;for(f=0;f<N.length;f++)b=b||N[f].tagName.match(BLOCKELEMENTS);b?(m.after(N),h=m.next(),m.remove(),m=h):(L.append(m[0].childNodes),m.after(L),m.remove(),m=L)}else if(m.parent()[0].tagName.toLowerCase()!==p||m.parent().hasClass("ta-bind"))if(S.match(LISTELEMENTS))m.wrap(c);else{for(N=e.getOnlySelectedElements(),0===N.length&&(N=[m[0]]),f=0;f<N.length;f++)if(3===N[f].nodeType||!N[f].tagName.match(BLOCKELEMENTS))for(;3===N[f].nodeType||!N[f].tagName||!N[f].tagName.match(BLOCKELEMENTS);)N[f]=N[f].parentNode;if(angular.element(N[0]).hasClass("ta-bind"))m=angular.element(c),m[0].innerHTML=N[0].innerHTML,N[0].innerHTML=m[0].outerHTML;else if("blockquote"===p){for(u="",f=0;f<N.length;f++)u+=N[f].outerHTML;for(m=angular.element(c),m[0].innerHTML=u,N[0].parentNode.insertBefore(m[0],N[0]),f=N.length-1;f>=0;f--)N[f].parentNode&&N[f].parentNode.removeChild(N[f])}else for(f=0;f<N.length;f++)m=angular.element(c),m[0].innerHTML=N[f].innerHTML,N[f].parentNode.insertBefore(m[0],N[f]),N[f].parentNode.removeChild(N[f])}else{var O=m.parent(),A=O.contents();for(f=0;f<A.length;f++)O.parent().hasClass("ta-bind")&&3===A[f].nodeType&&(L=angular.element("<"+a+">"),L[0].innerHTML=A[f].outerHTML,A[f]=L[0]),O.parent()[0].insertBefore(A[f],O[0]);O.remove()}return void e.setSelectionToElementEnd(m[0])}if("createlink"===s.toLowerCase()){var B='<a href="'+c+'" target="'+(g.a.target?g.a.target:"")+'">',y="</a>",R=e.getSelection();if(R.collapsed)e.insertHtml(B+c+y,i);else if(rangy.getSelection().getRangeAt(0).canSurroundContents()){var D=angular.element(B+y)[0];rangy.getSelection().getRangeAt(0).surroundContents(D)}return}if("inserthtml"===s.toLowerCase())return void e.insertHtml(c,i)}}try{n[0].execCommand(s,d,c)}catch(E){}}}}]).service("taSelection",["$window","$document","taDOM",function(e,t,n){var r=t[0],a=e.rangy,o=function(e,t){return e.tagName&&e.tagName.match(/^br$/i)&&0===t&&!e.previousSibling?{element:e.parentNode,offset:0}:{element:e,offset:t}},l={getSelection:function(){var e=a.getSelection().getRangeAt(0),t=e.commonAncestorContainer,n={start:o(e.startContainer,e.startOffset),end:o(e.endContainer,e.endOffset),collapsed:e.collapsed};return t=3===t.nodeType?t.parentNode:t,t.parentNode===n.start.element||t.parentNode===n.end.element?n.container=t.parentNode:n.container=t,n},getOnlySelectedElements:function(){var e=a.getSelection().getRangeAt(0),t=e.commonAncestorContainer;return t=3===t.nodeType?t.parentNode:t,e.getNodes([1],function(e){return e.parentNode===t})},getSelectionElement:function(){return l.getSelection().container},setSelection:function(e,t,n){var r=a.createRange();r.setStart(e,t),r.setEnd(e,n),a.getSelection().setSingleRange(r)},setSelectionBeforeElement:function(e){var t=a.createRange();t.selectNode(e),t.collapse(!0),a.getSelection().setSingleRange(t)},setSelectionAfterElement:function(e){var t=a.createRange();t.selectNode(e),t.collapse(!1),a.getSelection().setSingleRange(t)},setSelectionToElementStart:function(e){var t=a.createRange();t.selectNodeContents(e),t.collapse(!0),a.getSelection().setSingleRange(t)},setSelectionToElementEnd:function(e){var t=a.createRange();t.selectNodeContents(e),t.collapse(!1),e.childNodes&&e.childNodes[e.childNodes.length-1]&&"br"===e.childNodes[e.childNodes.length-1].nodeName&&(t.startOffset=t.endOffset=t.startOffset-1),a.getSelection().setSingleRange(t)},insertHtml:function(e,t){var o,i,s,d,c,g,f,m=angular.element("<div>"+e+"</div>"),u=a.getSelection().getRangeAt(0),N=r.createDocumentFragment(),h=m[0].childNodes,p=!0;if(h.length>0){for(d=[],s=0;s<h.length;s++)"p"===h[s].nodeName.toLowerCase()&&""===h[s].innerHTML.trim()||3===h[s].nodeType&&""===h[s].nodeValue.trim()||(p=p&&!BLOCKELEMENTS.test(h[s].nodeName),d.push(h[s]));for(var C=0;C<d.length;C++)g=N.appendChild(d[C]);!p&&u.collapsed&&/^(|<br(|\/)>)$/i.test(u.startContainer.innerHTML)&&u.selectNode(u.startContainer)}else p=!0,g=N=r.createTextNode(e);if(p)u.deleteContents();else if(u.collapsed&&u.startContainer!==t)if(u.startContainer.innerHTML&&u.startContainer.innerHTML.match(/^<[^>]*>$/i))o=u.startContainer,1===u.startOffset?(u.setStartAfter(o),u.setEndAfter(o)):(u.setStartBefore(o),u.setEndBefore(o));else{if(3===u.startContainer.nodeType&&u.startContainer.parentNode!==t)for(o=u.startContainer.parentNode,i=o.cloneNode(),n.splitNodes(o.childNodes,o,i,u.startContainer,u.startOffset);!VALIDELEMENTS.test(o.nodeName);){angular.element(o).after(i),o=o.parentNode;var L=i;i=o.cloneNode(),n.splitNodes(o.childNodes,o,i,L)}else o=u.startContainer,i=o.cloneNode(),n.splitNodes(o.childNodes,o,i,void 0,void 0,u.startOffset);if(angular.element(o).after(i),u.setStartAfter(o),u.setEndAfter(o),/^(|<br(|\/)>)$/i.test(o.innerHTML.trim())&&(u.setStartBefore(o),u.setEndBefore(o),angular.element(o).remove()),/^(|<br(|\/)>)$/i.test(i.innerHTML.trim())&&angular.element(i).remove(),"li"===o.nodeName.toLowerCase()){for(f=r.createDocumentFragment(),c=0;c<N.childNodes.length;c++)m=angular.element("<li>"),n.transferChildNodes(N.childNodes[c],m[0]),n.transferNodeAttributes(N.childNodes[c],m[0]),f.appendChild(m[0]);N=f,g&&(g=N.childNodes[N.childNodes.length-1],g=g.childNodes[g.childNodes.length-1])}}else u.deleteContents();u.insertNode(N),g&&l.setSelectionToElementEnd(g)}};return l}]).service("taDOM",function(){var e={getByAttribute:function(t,n){var r=[],a=t.children();return a.length&&angular.forEach(a,function(t){r=r.concat(e.getByAttribute(angular.element(t),n))}),void 0!==t.attr(n)&&r.push(t),r},transferChildNodes:function(e,t){for(t.innerHTML="";e.childNodes.length>0;)t.appendChild(e.childNodes[0]);return t},splitNodes:function(t,n,r,a,o,l){if(!a&&isNaN(l))throw new Error("taDOM.splitNodes requires a splitNode or splitIndex");for(var i=document.createDocumentFragment(),s=document.createDocumentFragment(),d=0;t.length>0&&(isNaN(l)||l!==d)&&t[0]!==a;)i.appendChild(t[0]),d++;for(!isNaN(o)&&o>=0&&t[0]&&(i.appendChild(document.createTextNode(t[0].nodeValue.substring(0,o))),t[0].nodeValue=t[0].nodeValue.substring(o));t.length>0;)s.appendChild(t[0]);e.transferChildNodes(i,n),e.transferChildNodes(s,r)},transferNodeAttributes:function(e,t){for(var n=0;n<e.attributes.length;n++)t.setAttribute(e.attributes[n].name,e.attributes[n].value);return t}};return e});