angular.module("textAngular.taBind",["textAngular.factories","textAngular.DOM"]).service("_taBlankTest",[function(){var e=/<(a|abbr|acronym|bdi|bdo|big|cite|code|del|dfn|img|ins|kbd|label|map|mark|q|ruby|rp|rt|s|samp|time|tt|var)[^>]*(>|$)/i;return function(t){return function(n){if(!n)return!0;var a,r=/(^[^<]|>)[^<]/i.exec(n);return r?a=r.index:(n=n.toString().replace(/="[^"]*"/i,"").replace(/="[^"]*"/i,"").replace(/="[^"]*"/i,"").replace(/="[^"]*"/i,""),a=n.indexOf(">")),n=n.trim().substring(a,a+100),/^[^<>]+$/i.test(n)?!1:0===n.length||n===t||/^>(\s|&nbsp;)*<\/[^>]+>$/gi.test(n)?!0:/>\s*[^\s<]/i.test(n)||e.test(n)?!1:!0}}}]).directive("taButton",[function(){return{link:function(e,t,n){t.attr("unselectable","on"),t.on("mousedown",function(e,t){return t&&angular.extend(e,t),e.preventDefault(),!1})}}}]).directive("taBind",["taSanitize","$timeout","$window","$document","taFixChrome","taBrowserTag","taSelection","taSelectableElements","taApplyCustomRenderers","taOptions","_taBlankTest","$parse","taDOM",function(e,t,n,a,r,i,l,o,s,d,u,c,f){return{priority:2,require:["ngModel","?ngModelOptions"],link:function(i,p,h,m){var v,g,b,L,w=m[0],C=m[1]||{},N=void 0!==p.attr("contenteditable")&&p.attr("contenteditable"),y=N||"textarea"===p[0].tagName.toLowerCase()||"input"===p[0].tagName.toLowerCase(),D=!1,k=!1,x=!1,$=h.taUnsafeSanitizer||d.disableSanitizer,S=/^(9|19|20|27|33|34|35|36|37|38|39|40|45|112|113|114|115|116|117|118|119|120|121|122|123|144|145)$/i,M=/^(8|13|32|46|59|61|107|109|186|187|188|189|190|191|192|219|220|221|222)$/i;void 0===h.taDefaultWrap&&(h.taDefaultWrap="p"),""===h.taDefaultWrap?(b="",L=void 0===_browserDetect.ie?"<div><br></div>":_browserDetect.ie>=11?"<p><br></p>":_browserDetect.ie<=8?"<P>&nbsp;</P>":"<p>&nbsp;</p>"):(b=void 0===_browserDetect.ie||_browserDetect.ie>=11?"<"+h.taDefaultWrap+"><br></"+h.taDefaultWrap+">":_browserDetect.ie<=8?"<"+h.taDefaultWrap.toUpperCase()+"></"+h.taDefaultWrap.toUpperCase()+">":"<"+h.taDefaultWrap+"></"+h.taDefaultWrap+">",L=void 0===_browserDetect.ie||_browserDetect.ie>=11?"<"+h.taDefaultWrap+"><br></"+h.taDefaultWrap+">":_browserDetect.ie<=8?"<"+h.taDefaultWrap.toUpperCase()+">&nbsp;</"+h.taDefaultWrap.toUpperCase()+">":"<"+h.taDefaultWrap+">&nbsp;</"+h.taDefaultWrap+">"),C.$options||(C.$options={});var E=u(L),T=function(e){if(E(e))return e;var t=angular.element("<div>"+e+"</div>");if(0===t.children().length)e="<"+h.taDefaultWrap+">"+e+"</"+h.taDefaultWrap+">";else{var n,a=t[0].childNodes,r=!1;for(n=0;n<a.length&&!(r=a[n].nodeName.toLowerCase().match(BLOCKELEMENTS));n++);if(r)for(e="",n=0;n<a.length;n++)if(a[n].nodeName.toLowerCase().match(BLOCKELEMENTS))e+=a[n].outerHTML;else{var i=a[n].outerHTML||a[n].nodeValue;e+=""!==i.trim()?"<"+h.taDefaultWrap+">"+i+"</"+h.taDefaultWrap+">":i}else e="<"+h.taDefaultWrap+">"+e+"</"+h.taDefaultWrap+">"}return e};h.taPaste&&(g=c(h.taPaste)),p.addClass("ta-bind");var _;i["$undoManager"+(h.id||"")]=w.$undoManager={_stack:[],_index:0,_max:1e3,push:function(e){return"undefined"==typeof e||null===e||"undefined"!=typeof this.current()&&null!==this.current()&&e===this.current()?e:(this._index<this._stack.length-1&&(this._stack=this._stack.slice(0,this._index+1)),this._stack.push(e),_&&t.cancel(_),this._stack.length>this._max&&this._stack.shift(),this._index=this._stack.length-1,e)},undo:function(){return this.setToIndex(this._index-1)},redo:function(){return this.setToIndex(this._index+1)},setToIndex:function(e){return 0>e||e>this._stack.length-1?void 0:(this._index=e,this.current())},current:function(){return this._stack[this._index]}};var W,I=i["$undoTaBind"+(h.id||"")]=function(){if(!D&&N){var e=w.$undoManager.undo();"undefined"!=typeof e&&null!==e&&(J(e),A(e,!1),W&&t.cancel(W),W=t(function(){p[0].focus(),l.setSelectionToElementEnd(p[0])},1))}},H=i["$redoTaBind"+(h.id||"")]=function(){if(!D&&N){var e=w.$undoManager.redo();"undefined"!=typeof e&&null!==e&&(J(e),A(e,!1),W&&t.cancel(W),W=t(function(){p[0].focus(),l.setSelectionToElementEnd(p[0])},1))}},V=function(){if(N)return p[0].innerHTML;if(y)return p.val();throw"textAngular Error: attempting to update non-editable taBind"},A=function(e,t,n){x=n||!1,("undefined"==typeof t||null===t)&&(t=N),("undefined"==typeof e||null===e)&&(e=V()),E(e)?(""!==w.$viewValue&&w.$setViewValue(""),t&&""!==w.$undoManager.current()&&w.$undoManager.push("")):(G(),w.$viewValue!==e&&(w.$setViewValue(e),t&&w.$undoManager.push(e))),w.$render()};i["updateTaBind"+(h.id||"")]=function(){D||A(void 0,void 0,!0)};var B=function(t){return w.$oldViewValue=e(r(t),w.$oldViewValue,$)};if(p.attr("required")&&(w.$validators.required=function(e,t){return!E(e||t)}),w.$parsers.push(B),w.$parsers.unshift(T),w.$formatters.push(B),w.$formatters.unshift(T),w.$formatters.unshift(function(e){return w.$undoManager.push(e||"")}),y)if(i.events={},N){var O=!1,K=function(n){if(n&&n.trim().length){if(n.match(/class=["']*Mso(Normal|List)/i)){var a=n.match(/<!--StartFragment-->([\s\S]*?)<!--EndFragment-->/i);a=a?a[1]:n,a=a.replace(/<o:p>[\s\S]*?<\/o:p>/gi,"").replace(/class=(["']|)MsoNormal(["']|)/gi,"");var r=angular.element("<div>"+a+"</div>"),o=angular.element("<div></div>"),s={element:null,lastIndent:[],lastLi:null,isUl:!1};s.lastIndent.peek=function(){var e=this.length;return e>0?this[e-1]:void 0};for(var d=function(e){s.isUl=e,s.element=angular.element(e?"<ul>":"<ol>"),s.lastIndent=[],s.lastIndent.peek=function(){var e=this.length;return e>0?this[e-1]:void 0},s.lastLevelMatch=null},u=0;u<=r[0].childNodes.length;u++)if(r[0].childNodes[u]&&"#text"!==r[0].childNodes[u].nodeName&&"p"===r[0].childNodes[u].tagName.toLowerCase()){var c=angular.element(r[0].childNodes[u]),h=(c.attr("class")||"").match(/MsoList(Bullet|Number|Paragraph)(CxSp(First|Middle|Last)|)/i);if(h){if(c[0].childNodes.length<2||c[0].childNodes[1].childNodes.length<1)continue;var m="bullet"===h[1].toLowerCase()||"number"!==h[1].toLowerCase()&&!(/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(c[0].childNodes[1].innerHTML)||/^[^0-9a-z<]*[0-9a-z]+[^0-9a-z<>]</i.test(c[0].childNodes[1].childNodes[0].innerHTML)),v=(c.attr("style")||"").match(/margin-left:([\-\.0-9]*)/i),b=parseFloat(v?v[1]:0),L=(c.attr("style")||"").match(/mso-list:l([0-9]+) level([0-9]+) lfo[0-9+]($|;)/i);if(L&&L[2]&&(b=parseInt(L[2])),L&&(!s.lastLevelMatch||L[1]!==s.lastLevelMatch[1])||!h[3]||"first"===h[3].toLowerCase()||null===s.lastIndent.peek()||s.isUl!==m&&s.lastIndent.peek()===b)d(m),o.append(s.element);else if(null!=s.lastIndent.peek()&&s.lastIndent.peek()<b)s.element=angular.element(m?"<ul>":"<ol>"),s.lastLi.append(s.element);else if(null!=s.lastIndent.peek()&&s.lastIndent.peek()>b){for(;null!=s.lastIndent.peek()&&s.lastIndent.peek()>b;)if("li"!==s.element.parent()[0].tagName.toLowerCase()){if(!/[uo]l/i.test(s.element.parent()[0].tagName.toLowerCase()))break;s.element=s.element.parent(),s.lastIndent.pop()}else s.element=s.element.parent();s.isUl="ul"===s.element[0].tagName.toLowerCase(),m!==s.isUl&&(d(m),o.append(s.element))}s.lastLevelMatch=L,b!==s.lastIndent.peek()&&s.lastIndent.push(b),s.lastLi=angular.element("<li>"),s.element.append(s.lastLi),s.lastLi.html(c.html().replace(/<!(--|)\[if !supportLists\](--|)>[\s\S]*?<!(--|)\[endif\](--|)>/gi,"")),c.remove()}else d(!1),o.append(c)}var C=function(e){e=angular.element(e);for(var t=e[0].childNodes.length-1;t>=0;t--)e.after(e[0].childNodes[t]);e.remove()};angular.forEach(o.find("span"),function(e){e.removeAttribute("lang"),e.attributes.length<=0&&C(e)}),angular.forEach(o.find("font"),C),n=o.html()}else{if(n=n.replace(/<(|\/)meta[^>]*?>/gi,""),n.match(/<[^>]*?(ta-bind)[^>]*?>/)){if(n.match(/<[^>]*?(text-angular)[^>]*?>/)){var N=angular.element("<div>"+n+"</div>");N.find("textarea").remove();for(var y=f.getByAttribute(N,"ta-bind"),D=0;D<y.length;D++){for(var k=y[D][0].parentNode.parentNode,x=0;x<y[D][0].childNodes.length;x++)k.parentNode.insertBefore(y[D][0].childNodes[x],k);k.parentNode.removeChild(k)}n=N.html().replace('<br class="Apple-interchange-newline">',"")}}else n.match(/^<span/)&&(n=n.replace(/<(|\/)span[^>]*?>/gi,""));n=n.replace(/<br class="Apple-interchange-newline"[^>]*?>/gi,"").replace(/<span class="Apple-converted-space">( |&nbsp;)<\/span>/gi,"&nbsp;")}/<li(\s.*)?>/i.test(n)&&/(<ul(\s.*)?>|<ol(\s.*)?>).*<li(\s.*)?>/i.test(n)===!1&&(n=n.replace(/<li(\s.*)?>.*<\/li(\s.*)?>/i,"<ul>$&</ul>")),g&&(n=g(i,{$html:n})||n),n=e(n,"",$),l.insertHtml(n,p[0]),t(function(){w.$setViewValue(V()),O=!1,p.removeClass("processing-paste")},0)}else O=!1,p.removeClass("processing-paste")};p.on("paste",i.events.paste=function(e,r){if(r&&angular.extend(e,r),D||O)return e.stopPropagation(),e.preventDefault(),!1;O=!0,p.addClass("processing-paste");var i,l=(e.originalEvent||e).clipboardData;if(l&&l.getData&&l.types.length>0){for(var o="",s=0;s<l.types.length;s++)o+=" "+l.types[s];return/text\/html/i.test(o)?i=l.getData("text/html"):/text\/plain/i.test(o)&&(i=l.getData("text/plain")),K(i),e.stopPropagation(),e.preventDefault(),!1}var d=n.rangy.saveSelection(),u=angular.element('<div class="ta-hidden-input" contenteditable="true"></div>');a.find("body").append(u),u[0].focus(),t(function(){n.rangy.restoreSelection(d),K(u[0].innerHTML),p[0].focus(),u.remove()},0)}),p.on("cut",i.events.cut=function(e){D?e.preventDefault():t(function(){w.$setViewValue(V())},0)}),p.on("keydown",i.events.keydown=function(e,t){if(t&&angular.extend(e,t),!D)if(e.altKey||!e.metaKey&&!e.ctrlKey){if(13===e.keyCode&&!e.shiftKey){var n,a=l.getSelectionElement();if(!a.tagName.match(VALIDELEMENTS))return;var r=angular.element(b);if(/^<br(|\/)>$/i.test(a.innerHTML.trim())&&"blockquote"===a.parentNode.tagName.toLowerCase()&&!a.nextSibling){n=angular.element(a);var i=n.parent();i.after(r),n.remove(),0===i.children().length&&i.remove(),l.setSelectionToElementStart(r[0]),e.preventDefault()}else/^<[^>]+><br(|\/)><\/[^>]+>$/i.test(a.innerHTML.trim())&&"blockquote"===a.tagName.toLowerCase()&&(n=angular.element(a),n.after(r),n.remove(),l.setSelectionToElementStart(r[0]),e.preventDefault())}}else 90!==e.keyCode||e.shiftKey?(90===e.keyCode&&e.shiftKey||89===e.keyCode&&!e.shiftKey)&&(H(),e.preventDefault()):(I(),e.preventDefault())});var U;if(p.on("keyup",i.events.keyup=function(e,a){if(a&&angular.extend(e,a),9===e.keyCode){var r=l.getSelection();return void(r.start.element===p[0]&&p.children().length&&l.setSelectionToElementStart(p.children()[0]))}if(_&&t.cancel(_),!D&&!S.test(e.keyCode)){if(""!==b&&13===e.keyCode&&!e.shiftKey){for(var i=l.getSelectionElement();!i.tagName.match(VALIDELEMENTS)&&i!==p[0];)i=i.parentNode;if(i.tagName.toLowerCase()!==h.taDefaultWrap&&"li"!==i.tagName.toLowerCase()&&(""===i.innerHTML.trim()||"<br>"===i.innerHTML.trim())){var o=angular.element(b);angular.element(i).replaceWith(o),l.setSelectionToElementStart(o[0])}}var s=V();if(""!==b&&""===s.trim())J(b),l.setSelectionToElementStart(p.children()[0]);else if("<"!==s.substring(0,1)&&""!==h.taDefaultWrap){var d=n.rangy.saveSelection();s=V(),s="<"+h.taDefaultWrap+">"+s+"</"+h.taDefaultWrap+">",J(s),n.rangy.restoreSelection(d)}var u=v!==e.keyCode&&M.test(e.keyCode);U&&t.cancel(U),U=t(function(){A(s,u,!0)},C.$options.debounce||400),u||(_=t(function(){w.$undoManager.push(s)},250)),v=e.keyCode}}),p.on("blur",i.events.blur=function(){k=!1,D?(x=!0,w.$render()):A(void 0,void 0,!0)}),h.placeholder&&(_browserDetect.ie>8||void 0===_browserDetect.ie)){var z;if(!h.id)throw"textAngular Error: An unique ID is required for placeholders to work";z=addCSSRule("#"+h.id+".placeholder-text:before",'content: "'+h.placeholder+'"'),i.$on("$destroy",function(){removeCSSRule(z)})}p.on("focus",i.events.focus=function(){k=!0,p.removeClass("placeholder-text")}),p.on("mouseup",i.events.mouseup=function(){var e=l.getSelection();e.start.element===p[0]&&p.children().length&&l.setSelectionToElementStart(p.children()[0])}),p.on("mousedown",i.events.mousedown=function(e,t){t&&angular.extend(e,t),e.stopPropagation()})}else{p.on("change blur",i.events.change=i.events.blur=function(){D||w.$setViewValue(V())}),p.on("keydown",i.events.keydown=function(e,t){if(t&&angular.extend(e,t),9===e.keyCode){var n=this.selectionStart,a=this.selectionEnd,r=p.val();if(e.shiftKey){var i=r.lastIndexOf("\n",n),l=r.lastIndexOf("	",n);-1!==l&&l>=i&&(p.val(r.substring(0,l)+r.substring(l+1)),this.selectionStart=this.selectionEnd=n-1)}else p.val(r.substring(0,n)+"	"+r.substring(a)),this.selectionStart=this.selectionEnd=n+1;e.preventDefault()}});var q=function(e,t){for(var n="",a=0;t>a;a++)n+=e;return n},F=function(e,t){var n="",a=e.childNodes;t++,n+=q("	",t-1)+e.outerHTML.substring(0,e.outerHTML.indexOf("<li"));for(var r=0;r<a.length;r++)a[r].outerHTML&&(n+="ul"===a[r].nodeName.toLowerCase()||"ol"===a[r].nodeName.toLowerCase()?"\n"+F(a[r],t):"\n"+q("	",t)+a[r].outerHTML);return n+="\n"+q("	",t-1)+e.outerHTML.substring(e.outerHTML.lastIndexOf("<"))};w.$formatters.unshift(function(e){var t=angular.element("<div>"+e+"</div>")[0].childNodes;if(t.length>0){e="";for(var n=0;n<t.length;n++)t[n].outerHTML&&(e.length>0&&(e+="\n"),e+="ul"===t[n].nodeName.toLowerCase()||"ol"===t[n].nodeName.toLowerCase()?""+F(t[n],0):""+t[n].outerHTML)}return e})}var P,R=function(e){return i.$emit("ta-element-select",this),e.preventDefault(),!1},j=function(e,n){if(n&&angular.extend(e,n),!dropFired&&!D){dropFired=!0;var a;a=e.originalEvent?e.originalEvent.dataTransfer:e.dataTransfer,i.$emit("ta-drop-event",this,e,a),t(function(){dropFired=!1,A(void 0,void 0,!0)},100)}},G=i["reApplyOnSelectorHandlers"+(h.id||"")]=function(){D||angular.forEach(o,function(e){p.find(e).off("click",R).on("click",R)})},J=function(e){p[0].innerHTML=e},Q=!1;w.$render=function(){if(!Q){Q=!0;var e=w.$viewValue||"";x||(N&&k&&(p.removeClass("placeholder-text"),P&&t.cancel(P),P=t(function(){k||(p[0].focus(),l.setSelectionToElementEnd(p.children()[p.children().length-1])),P=void 0},1)),N?(J(h.placeholder?""===e?b:e:""===e?b:e),D?p.off("drop",j):(G(),p.on("drop",j))):"textarea"!==p[0].tagName.toLowerCase()&&"input"!==p[0].tagName.toLowerCase()?J(s(e)):p.val(e)),N&&h.placeholder&&(""===e?k?p.removeClass("placeholder-text"):p.addClass("placeholder-text"):p.removeClass("placeholder-text")),Q=x=!1}},h.taReadonly&&(D=i.$eval(h.taReadonly),D?(p.addClass("ta-readonly"),("textarea"===p[0].tagName.toLowerCase()||"input"===p[0].tagName.toLowerCase())&&p.attr("disabled","disabled"),void 0!==p.attr("contenteditable")&&p.attr("contenteditable")&&p.removeAttr("contenteditable")):(p.removeClass("ta-readonly"),"textarea"===p[0].tagName.toLowerCase()||"input"===p[0].tagName.toLowerCase()?p.removeAttr("disabled"):N&&p.attr("contenteditable","true")),i.$watch(h.taReadonly,function(e,t){t!==e&&(e?(p.addClass("ta-readonly"),("textarea"===p[0].tagName.toLowerCase()||"input"===p[0].tagName.toLowerCase())&&p.attr("disabled","disabled"),void 0!==p.attr("contenteditable")&&p.attr("contenteditable")&&p.removeAttr("contenteditable"),angular.forEach(o,function(e){p.find(e).on("click",R)}),p.off("drop",j)):(p.removeClass("ta-readonly"),"textarea"===p[0].tagName.toLowerCase()||"input"===p[0].tagName.toLowerCase()?p.removeAttr("disabled"):N&&p.attr("contenteditable","true"),angular.forEach(o,function(e){p.find(e).off("click",R)}),p.on("drop",j)),D=e)})),N&&!D&&(angular.forEach(o,function(e){p.find(e).on("click",R)}),p.on("drop",j),p.on("blur",function(){_browserDetect.webkit&&(globalContentEditableBlur=!0)}))}}}]);